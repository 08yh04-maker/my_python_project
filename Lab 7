import sqlite3
import csv

# Создание БД и нескольких таблиц
def create_tables():
    conn = sqlite3.connect('company.db')
    cur = conn.cursor()
    
    # Таблица departments
    cur.execute('''
        CREATE TABLE IF NOT EXISTS departments (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            name TEXT NOT NULL,
            budget REAL
        )
    ''')
    
    # Таблица employees
    cur.execute('''
        CREATE TABLE IF NOT EXISTS employees (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            name TEXT NOT NULL,
            position TEXT,
            salary REAL,
            department_id INTEGER,
            FOREIGN KEY (department_id) REFERENCES departments (id)
        )
    ''')
    
    conn.commit()
    conn.close()
    print("Таблицы созданы успешно!")

# Вставка данных в таблицы
def insert_data():
    conn = sqlite3.connect('company.db')
    cur = conn.cursor()
    
    # Вставка данных в departments
    departments = [
        ('IT', 50000),
        ('HR', 30000),
        ('Finance', 40000),
        ('Marketing', 35000)
    ]
    
    cur.executemany('INSERT INTO departments (name, budget) VALUES (?, ?)', departments)
    
    # Вставка данных в employees
    employees = [
        ('Иван Петров', 'Разработчик', 80000, 1),
        ('Мария Сидорова', 'Менеджер по персоналу', 50000, 2),
        ('Алексей Козлов', 'Бухгалтер', 60000, 3),
        ('Елена Новикова', 'Маркетолог', 55000, 4),
        ('Дмитрий Волков', 'Старший разработчик', 100000, 1)
    ]
    
    cur.executemany('''
        INSERT INTO employees (name, position, salary, department_id) 
        VALUES (?, ?, ?, ?)
    ''', employees)
    
    conn.commit()
    conn.close()
    print("Данные вставлены успешно!")

# Обновление записи
def update_employee():
    conn = sqlite3.connect('company.db')
    cur = conn.cursor()
    
    # Повышение зарплаты разработчикам
    cur.execute('''
        UPDATE employees 
        SET salary = salary * 1.1 
        WHERE position LIKE '%разработчик%'
    ''')
    
    # Обновление конкретного сотрудника
    cur.execute('''
        UPDATE employees 
        SET position = 'Ведущий маркетолог', salary = 60000 
        WHERE name = 'Елена Новикова'
    ''')
    
    conn.commit()
    conn.close()
    print("Записи обновлены успешно!")

# Проверка результатов
def check_results():
    conn = sqlite3.connect('company.db')
    cur = conn.cursor()
    
    print("\n--- Все сотрудники ---")
    cur.execute('''
        SELECT e.name, e.position, e.salary, d.name as department 
        FROM employees e 
        JOIN departments d ON e.department_id = d.id
    ''')
    
    for row in cur.fetchall():
        print(f"{row[0]} - {row[1]} - {row[2]} руб. - {row[3]}")
    
    conn.close()

# Основная функция для среднего уровня
def medium_level():
    print("=== СРЕДНИЙ УРОВЕНЬ СЛОЖНОСТИ ===")
    create_tables()
    insert_data()
    update_employee()
    check_results()


from sqlalchemy import create_engine, Column, Integer, String, Float, ForeignKey
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import sessionmaker, relationship

Base = declarative_base()

# Модели для ORM
class Department(Base):
    __tablename__ = 'departments_orm'
    
    id = Column(Integer, primary_key=True, autoincrement=True)
    name = Column(String(100), nullable=False)
    budget = Column(Float)
    
    employees = relationship("Employee", back_populates="department")
    
    def __repr__(self):
        return f"<Department(id={self.id}, name='{self.name}', budget={self.budget})>"

class Employee(Base):
    __tablename__ = 'employees_orm'
    
    id = Column(Integer, primary_key=True, autoincrement=True)
    name = Column(String(100), nullable=False)
    position = Column(String(100))
    salary = Column(Float)
    department_id = Column(Integer, ForeignKey('departments_orm.id'))
    
    department = relationship("Department", back_populates="employees")
    
    def __repr__(self):
        return f"<Employee(id={self.id}, name='{self.name}', position='{self.position}')>"

# CRUD операции через ORM
class CompanyCRUD:
    def __init__(self, db_url='sqlite:///company_orm.db'):
        self.engine = create_engine(db_url)
        Base.metadata.create_all(self.engine)
        Session = sessionmaker(bind=self.engine)
        self.session = Session()
    
    # CREATE
    def create_department(self, name, budget):
        department = Department(name=name, budget=budget)
        self.session.add(department)
        self.session.commit()
        return department
    
    def create_employee(self, name, position, salary, department_id):
        employee = Employee(
            name=name, 
            position=position, 
            salary=salary, 
            department_id=department_id
        )
        self.session.add(employee)
        self.session.commit()
        return employee
    
    # READ
    def get_all_employees(self):
        return self.session.query(Employee).all()
    
    def get_employee_by_id(self, employee_id):
        return self.session.query(Employee).filter(Employee.id == employee_id).first()
    
    def get_employees_by_department(self, department_name):
        return self.session.query(Employee).join(Department).filter(
            Department.name == department_name
        ).all()
    
    # UPDATE
    def update_employee_salary(self, employee_id, new_salary):
        employee = self.get_employee_by_id(employee_id)
        if employee:
            employee.salary = new_salary
            self.session.commit()
            return True
        return False
    
    def update_employee_position(self, employee_id, new_position):
        employee = self.get_employee_by_id(employee_id)
        if employee:
            employee.position = new_position
            self.session.commit()
            return True
        return False
    
    # DELETE
    def delete_employee(self, employee_id):
        employee = self.get_employee_by_id(employee_id)
        if employee:
            self.session.delete(employee)
            self.session.commit()
            return True
        return False
    
    def close(self):
        self.session.close()

# Демонстрация CRUD операций
def demonstrate_crud():
    print("\n=== CRUD ЧЕРЕЗ ORM ===")
    crud = CompanyCRUD()
    
    # Создание отделов
    it_dept = crud.create_department("IT Development", 75000)
    hr_dept = crud.create_department("Human Resources", 45000)
    
    # Создание сотрудников
    emp1 = crud.create_employee("Сергей Иванов", "Team Lead", 120000, it_dept.id)
    emp2 = crud.create_employee("Ольга Смирнова", "HR Manager", 65000, hr_dept.id)
    emp3 = crud.create_employee("Павел Козлов", "Backend Developer", 90000, it_dept.id)
    
    # Чтение данных
    print("\n--- Все сотрудники ---")
    employees = crud.get_all_employees()
    for emp in employees:
        print(f"{emp.name} - {emp.position} - {emp.salary} руб.")
    
    # Обновление данных
    print("\n--- Обновление зарплаты ---")
    crud.update_employee_salary(emp3.id, 95000)
    updated_emp = crud.get_employee_by_id(emp3.id)
    print(f"Обновленная зарплата: {updated_emp.name} - {updated_emp.salary} руб.")
    
    # Удаление сотрудника
    print("\n--- Удаление сотрудника ---")
    crud.delete_employee(emp2.id)
    remaining_employees = crud.get_all_employees()
    print("Оставшиеся сотрудники:")
    for emp in remaining_employees:
        print(f"{emp.name} - {emp.position}")
    
    crud.close()


import psycopg2
from psycopg2 import sql

class PostgreSQLManager:
    def __init__(self, dbname='company', user='postgres', password='password', host='localhost'):
        self.conn_params = {
            'dbname': dbname,
            'user': user,
            'password': password,
            'host': host
        }
        self.connection = None
    
    def connect(self):
        try:
            self.connection = psycopg2.connect(**self.conn_params)
            print("Успешное подключение к PostgreSQL!")
            return True
        except Exception as e:
            print(f"Ошибка подключения: {e}")
            return False
    
    def create_tables(self):
        if not self.connection:
            print("Нет подключения к БД")
            return
        
        cursor = self.connection.cursor()
        
        # Создание таблицы projects
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS projects (
                id SERIAL PRIMARY KEY,
                name VARCHAR(100) NOT NULL,
                budget DECIMAL(10,2),
                start_date DATE,
                status VARCHAR(20) DEFAULT 'active'
            )
        ''')
        
        # Создание таблицы project_assignments
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS project_assignments (
                id SERIAL PRIMARY KEY,
                employee_id INTEGER,
                project_id INTEGER,
                role VARCHAR(50),
                hours_per_week INTEGER,
                assignment_date DATE DEFAULT CURRENT_DATE
            )
        ''')
        
        self.connection.commit()
        cursor.close()
        print("Таблицы в PostgreSQL созданы успешно!")
    
    def insert_sample_data(self):
        cursor = self.connection.cursor()
        
        # Вставка проектов
        projects = [
            ('Разработка нового сайта', 100000, '2024-01-15'),
            ('Внедрение CRM системы', 150000, '2024-02-01'),
            ('Аналитика продаж', 50000, '2024-01-20')
        ]
        
        for project in projects:
            cursor.execute(
                'INSERT INTO projects (name, budget, start_date) VALUES (%s, %s, %s)',
                project
            )
        
        # Вставка назначений на проекты
        assignments = [
            (1, 1, 'Техлид', 20),
            (3, 1, 'Разработчик', 40),
            (1, 2, 'Архитектор', 15),
            (3, 3, 'Аналитик', 25)
        ]
        
        for assignment in assignments:
            cursor.execute(
                'INSERT INTO project_assignments (employee_id, project_id, role, hours_per_week) VALUES (%s, %s, %s, %s)',
                assignment
            )
        
        self.connection.commit()
        cursor.close()
        print("Данные в PostgreSQL вставлены успешно!")
    
    def complex_query(self):
        cursor = self.connection.cursor()
        
        # Сложный запрос с JOIN и агрегацией
        cursor.execute('''
            SELECT 
                p.name as project_name,
                p.budget,
                COUNT(pa.employee_id) as team_size,
                SUM(pa.hours_per_week) as total_hours
            FROM projects p
            LEFT JOIN project_assignments pa ON p.id = pa.project_id
            GROUP BY p.id, p.name, p.budget
            ORDER BY p.budget DESC
        ''')
        
        print("\n--- Статистика по проектам (PostgreSQL) ---")
        for row in cursor.fetchall():
            print(f"Проект: {row[0]}, Бюджет: {row[1]}, Команда: {row[2]} чел., Часы: {row[3]}/нед.")
        
        cursor.close()
    
    def close(self):
        if self.connection:
            self.connection.close()
            print("Подключение к PostgreSQL закрыто")

def demonstrate_postgresql():
    print("\n=== РАБОТА С POSTGRESQL ===")
    
    # Замените параметры подключения на свои
    pg_manager = PostgreSQLManager(
        dbname='company',
        user='your_username',
        password='your_password',
        host='localhost'
    )
    
    if pg_manager.connect():
        pg_manager.create_tables()
        pg_manager.insert_sample_data()
        pg_manager.complex_query()
        pg_manager.close()

# Главная функция
def main():
    print("ЛАБОРАТОРНАЯ РАБОТА №7 - ВАРИАНТ 2")
    print("=" * 50)
    
    # Задания средней сложности
    medium_level()
    
    # Задания повышенной сложности
    demonstrate_crud()
    
    # Работа с PostgreSQL (раскомментируйте когда настроите PostgreSQL)
    # demonstrate_postgresql()
    
    print("\nВсе задания выполнены!")

if __name__ == "__main__":
    main()
